<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REHABAND App - BLE</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe', 
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .bg-primary-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .bg-success-gradient {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        }
        
        .bg-warning-gradient {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .bg-danger-gradient {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        /* Button hover effects */
        .btn-hover {
            transition: all 0.2s ease-in-out;
        }
        
        .btn-hover:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-hover:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* shadcn/ui inspired borders and shadows */
        .card-elegant {
            border: 1px solid hsl(214.3 31.8% 91.4%);
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
        }
        
        .card-elevated {
            border: 1px solid hsl(214.3 31.8% 91.4%);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .card-subtle {
            border: 1px solid hsl(214.3 31.8% 94%);
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        
        .scrollable-area {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        
        .scrollable-area::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollable-area::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .scrollable-area::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        
        .scrollable-area::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }
        
        /* Apple-inspired background */
        .apple-bg {
            background: 
                radial-gradient(ellipse 80% 50% at 20% -20%, rgba(120, 119, 198, 0.3), transparent),
                radial-gradient(ellipse 80% 50% at 80% 120%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(ellipse 60% 40% at 40% 40%, rgba(120, 119, 198, 0.15), transparent),
                linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #e2e8f0 100%);
            min-height: 100vh;
            backdrop-filter: blur(20px);
        }
    </style>
</head>
<body class="apple-bg">
    <div class="max-w-7xl mx-auto p-4 lg:p-8">
        <!-- Header -->
        <header class="bg-primary-gradient text-white rounded-xl shadow-lg mb-6 overflow-hidden">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center mb-2">
                    <h1 class="text-2xl font-bold flex items-center gap-2">
                        <i data-lucide="activity" class="w-6 h-6"></i>
                        REHABAND
                    </h1>
                    <span class="bg-white/20 text-xs px-3 py-1 rounded-full">Live Session</span>
                </div>
                <div class="flex items-center text-sm opacity-90">
                    <div class="w-2 h-2 bg-red-400 rounded-full mr-2 transition-colors duration-300" id="statusDot"></div>
                    <span id="statusText">Not Connected</span>
                </div>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 min-h-[calc(100vh-200px)]">
            <!-- Left Column - Controls & Data -->
            <div class="space-y-6 max-h-[calc(100vh-200px)] overflow-y-auto bg-gradient-to-br from-white/60 to-gray-50/40 rounded-2xl p-6 backdrop-blur-sm scrollable-area flex flex-col justify-start items-center">
                <!-- Connection Buttons -->
                <div class="bg-white rounded-xl card-elevated p-6 w-full">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <i data-lucide="bluetooth" class="w-5 h-5"></i>
                        Device Connection
                    </h2>
                    <div class="space-y-3">
                        <button id="connectBtn" class="w-full bg-primary-gradient text-white py-3 px-4 rounded-lg font-medium btn-hover flex items-center justify-center gap-2">
                            <i data-lucide="bluetooth" class="w-4 h-4"></i>
                            Connect to REHABAND
                        </button>
                        <button id="demoBtn" class="w-full bg-success-gradient text-white py-3 px-4 rounded-lg font-medium btn-hover flex items-center justify-center gap-2">
                            <i data-lucide="play-circle" class="w-4 h-4"></i>
                            Try Demo Mode
                        </button>
                    </div>
                </div>

                <!-- Session Controls -->
                <div class="bg-white rounded-xl card-elevated p-6 w-full">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                        Session Controls
                    </h2>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button id="startResetBtn" disabled class="bg-warning-gradient text-white py-3 px-4 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed btn-hover flex items-center justify-center gap-2">
                            <i data-lucide="play" class="w-4 h-4"></i>
                            Start Session
                        </button>
                        <button id="calibrateBtn" disabled class="bg-primary-gradient text-white py-3 px-4 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed btn-hover flex items-center justify-center gap-2">
                            <i data-lucide="target" class="w-4 h-4"></i>
                            Calibrate
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 text-center italic" id="sessionControlsStatus">âœ¨ First time? Click "Calibrate" to personalize your targets!</p>
                </div>

                <!-- Session Summary -->
                <div class="bg-white rounded-xl card-elevated p-6 w-full">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                            <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                            Session Summary
                        </h2>
                        <span class="text-xs bg-gray-100 px-3 py-1 rounded-full text-gray-600" id="duration">0 mins</span>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center p-4 bg-gray-50 rounded-lg card-subtle" id="totalRepsStat">
                            <div class="text-2xl font-bold text-gray-900" id="totalReps">0</div>
                            <div class="text-xs text-gray-500 uppercase tracking-wide">Total Reps</div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg card-subtle" id="goodRepsStat">
                            <div class="text-2xl font-bold text-gray-900" id="goodReps">0</div>
                            <div class="text-xs text-gray-500 uppercase tracking-wide">Good Form</div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg card-subtle" id="avgAngleStat">
                            <div class="text-2xl font-bold text-gray-900" id="avgAngle">--</div>
                            <div class="text-xs text-gray-500 uppercase tracking-wide">Avg Angle</div>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="bg-white rounded-xl card-elevated p-6 w-full">
                    <h2 class="text-lg font-semibold text-gray-900 mb-2 flex items-center gap-2">
                        <i data-lucide="sliders" class="w-5 h-5"></i>
                        Adjust Settings
                    </h2>
                    <p class="text-xs text-gray-500 text-center mb-4 italic">Changes apply instantly to connected device</p>
                    <div id="demoDisclaimer" class="hidden text-xs text-red-600 bg-red-50 p-3 rounded-lg mb-4">
                        <strong>Demo Mode:</strong> For best results, set Target ROM to <strong>90Â°</strong> and Max Speed to <strong>30Â°/s</strong><br>
                        This will show Rep 1 and Rep 3 as "Good" examples.
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <label class="text-sm font-medium text-gray-700">Target ROM</label>
                            <div class="flex items-center gap-2">
                                <button class="w-8 h-8 rounded-md border border-gray-300 bg-white hover:bg-gray-50 flex items-center justify-center text-gray-600 btn-hover" id="romDecBtn">âˆ’</button>
                                <div class="min-w-[50px] text-center text-sm font-semibold text-gray-900" id="romValue">95<span class="text-xs text-gray-500 ml-1">Â°</span></div>
                                <button class="w-8 h-8 rounded-md border border-gray-300 bg-white hover:bg-gray-50 flex items-center justify-center text-gray-600 btn-hover" id="romIncBtn">+</button>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <label class="text-sm font-medium text-gray-700">Max Speed for "Controlled" Rating</label>
                            <div class="flex items-center gap-2">
                                <button class="w-8 h-8 rounded-md border border-gray-300 bg-white hover:bg-gray-50 flex items-center justify-center text-gray-600 btn-hover" id="speedDecBtn">âˆ’</button>
                                <div class="min-w-[50px] text-center text-sm font-semibold text-gray-900" id="speedValue">30<span class="text-xs text-gray-500 ml-1">Â°/s</span></div>
                                <button class="w-8 h-8 rounded-md border border-gray-300 bg-white hover:bg-gray-50 flex items-center justify-center text-gray-600 btn-hover" id="speedIncBtn">+</button>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <label class="text-sm font-medium text-gray-700">Sound Alerts</label>
                            <button class="px-4 py-2 rounded-md text-sm font-medium text-white bg-green-500 btn-hover" id="soundToggleBtn">ON</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Instructions & History -->
            <div class="space-y-6 max-h-[calc(100vh-200px)] overflow-y-auto bg-gradient-to-bl from-blue-50/30 to-white/50 rounded-2xl p-6 backdrop-blur-sm scrollable-area flex flex-col justify-start items-center">
                <!-- Instructions -->
                <div class="bg-blue-50 rounded-xl card-elevated border-blue-200 p-6 w-full">
                    <h2 class="text-lg font-semibold text-blue-900 mb-4 flex items-center gap-2">
                        <i data-lucide="info" class="w-5 h-5"></i>
                        Instructions
                    </h2>
                    <div class="space-y-3 text-sm text-blue-800">
                        <div>
                            <strong class="font-semibold">Real Device:</strong> 1) Upload Arduino sketch to Nano 33 BLE, 2) Mount device 3cm above kneecap on thigh, 3) Click "Connect to REHABAND", 4) Click "Calibrate" and perform 5 perfect squats, 5) Use "Start Session" to begin tracking
                        </div>
                        <div>
                            <strong class="font-semibold">Demo:</strong> Click "Try Demo Mode" to see the interface with simulated squat data (set ROM=90Â°, Speed=30Â°/s for best demo results)
                        </div>
                    </div>
                </div>

                <!-- Rep History -->
                <div class="bg-white rounded-xl card-elevated p-6 flex flex-col h-full w-full">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <i data-lucide="history" class="w-5 h-5"></i>
                        Rep History
                    </h2>
                    <div id="repContainer" class="flex-1 overflow-y-auto scrollable-area space-y-3 max-h-[400px] min-h-[200px]">
                        <div class="text-center text-gray-500 py-8" id="noRepsMessage">
                            <i data-lucide="activity" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i>
                            <p class="text-sm">No reps yet. Start exercising to see data!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div class="fixed bottom-4 right-4 max-w-md hidden" id="errorMessage">
            <div class="bg-red-100 border border-red-200 text-red-700 px-4 py-3 rounded-lg shadow-lg">
                <div class="flex items-center gap-2">
                    <i data-lucide="alert-circle" class="w-5 h-5"></i>
                    <span class="text-sm font-medium">Error Message</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        let device, server, service;
        let romChar, speedChar, jerkinessChar, repCountChar, sessionControlChar, calibrationChar, targetROMChar, targetSpeedChar;
        let repsData = [];
        let sessionStartTime;
        let lastRepCount = 0;
        let isSessionActive = false;
        let isCalibrating = false;
        let calibrationData = [];
        let calibrationCount = 0;

        // Settings variables  
        let settings = {
            targetROM: 95,
            speedTarget: 30.0, // Now angular velocity in deg/s (lower = more controlled)
            soundAlerts: true
        };

        const connectBtn = document.getElementById('connectBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const repContainer = document.getElementById('repContainer');
        const errorMessage = document.getElementById('errorMessage');
        const noRepsMessage = document.getElementById('noRepsMessage');

        const demoBtn = document.getElementById('demoBtn');
        const startResetBtn = document.getElementById('startResetBtn');

        // Settings elements
        const romDecBtn = document.getElementById('romDecBtn');
        const romIncBtn = document.getElementById('romIncBtn');
        const romValue = document.getElementById('romValue');
        const speedDecBtn = document.getElementById('speedDecBtn');
        const speedIncBtn = document.getElementById('speedIncBtn');
        const speedValue = document.getElementById('speedValue');
        const soundToggleBtn = document.getElementById('soundToggleBtn');
        const demoDisclaimer = document.getElementById('demoDisclaimer');
        const calibrateBtn = document.getElementById('calibrateBtn');
        const sessionControlsStatus = document.getElementById('sessionControlsStatus');

        connectBtn.addEventListener('click', connectToDevice);
        demoBtn.addEventListener('click', startDemoMode);
        startResetBtn.addEventListener('click', toggleSession);
        calibrateBtn.addEventListener('click', startCalibration);

        // Settings event listeners
        romDecBtn.addEventListener('click', () => adjustSetting('rom', -5));
        romIncBtn.addEventListener('click', () => adjustSetting('rom', 5));
        speedDecBtn.addEventListener('click', () => adjustSetting('speed', -2.0)); // Adjust by 2 deg/s
        speedIncBtn.addEventListener('click', () => adjustSetting('speed', 2.0));
        soundToggleBtn.addEventListener('click', toggleSoundAlerts);

        // Check if Web Bluetooth is supported
        if (!navigator.bluetooth) {
            showError('Web Bluetooth is not supported. Please use Chrome or Edge browser.');
            connectBtn.disabled = true;
        }

        const isConnected = () => device && device.gatt && device.gatt.connected;

        async function connectToDevice() {
            try {
                hideError();
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin mr-2"></i>Connecting...';
                lucide.createIcons();

                // Request device
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'REHABAND' }],
                    optionalServices: [0x180D]
                });

                // Connect to GATT server
                statusText.textContent = 'Connecting to device...';
                server = await device.gatt.connect();
                
                // Get service
                statusText.textContent = 'Getting service...';
                service = await server.getPrimaryService(0x180D);

                // Get characteristics
                statusText.textContent = 'Getting characteristics...';
                romChar = await service.getCharacteristic(0x2A37);
                speedChar = await service.getCharacteristic(0x2A38);
                jerkinessChar = await service.getCharacteristic(0x2A39);
                repCountChar = await service.getCharacteristic(0x2A3A);
                
                // Try to get session control characteristic
                try {
                    sessionControlChar = await service.getCharacteristic(0x2A3B);
                } catch (error) {
                    console.log('Session control characteristic not available:', error.message);
                }
                
                // Try to get calibration and target characteristics
                try {
                    calibrationChar = await service.getCharacteristic(0x2A3C);
                    targetROMChar = await service.getCharacteristic(0x2A3D);
                    targetSpeedChar = await service.getCharacteristic(0x2A3E);
                    console.log('Calibration characteristics available');
                } catch (error) {
                    console.log('Calibration characteristics not available:', error.message);
                }

                // Start notifications
                statusText.textContent = 'Starting notifications...';
                await repCountChar.startNotifications();
                repCountChar.addEventListener('characteristicvaluechanged', handleRepCountChange);
                
                // Start calibration notifications if available
                if (calibrationChar) {
                    await calibrationChar.startNotifications();
                    calibrationChar.addEventListener('characteristicvaluechanged', handleCalibrationChange);
                }

                // Connection successful
                statusDot.classList.remove('bg-red-400');
                statusDot.classList.add('bg-green-400');
                statusText.textContent = 'Connected';
                connectBtn.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4 mr-2"></i>Connected';
                connectBtn.classList.remove('bg-primary-gradient');
                connectBtn.classList.add('bg-green-500');
                
                // Send current settings to Arduino immediately upon connection
                await sendSettingsToArduino();
                
                // Enable session controls
                startResetBtn.disabled = false;
                startResetBtn.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
                calibrateBtn.disabled = false;
                calibrateBtn.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
                sessionControlsStatus.textContent = 'âœ¨ First time? Click "Calibrate" to personalize your targets!';
                
                sessionStartTime = Date.now();
                updateDuration();

                // Add disconnect handler
                device.addEventListener('gattserverdisconnected', onDisconnected);

                console.log('Successfully connected to REHABAND device');

            } catch (error) {
                console.error('Connection failed:', error);
                showError(`Connection failed: ${error.message}`);
                resetConnectionState();
            }
        }

        async function handleRepCountChange(event) {
            try {
                const repNumber = event.target.value.getUint8(0);
                
                // Only process if it's a new rep
                if (repNumber > lastRepCount && repNumber <= 10) {
                    lastRepCount = repNumber;
                    
                    // Read other characteristics
                    const romValue = await romChar.readValue();
                    const speedValue = await speedChar.readValue();
                    const jerkinessValue = await jerkinessChar.readValue();

                    const rom = romValue.getUint8(0);
                    const speed = speedValue.getFloat32(0, true); // Now angular velocity (deg/s)
                    const jerkiness = jerkinessValue.getFloat32(0, true); // Now RMS jerk value

                    console.log(`Rep ${repNumber}: ROM=${rom}Â°, Speed=${speed}s, Jerkiness=${jerkiness}`);
                    
                    addRepCard(repNumber, rom, speed, jerkiness);
                    updateSummary();
                }
            } catch (error) {
                console.error('Error handling rep data:', error);
                showError(`Error reading rep data: ${error.message}`);
            }
        }

        async function handleCalibrationChange(event) {
            try {
                const calibrationStatus = event.target.value.getUint8(0);
                
                if (calibrationStatus === 1) {
                    // Calibration progress update - Arduino completed a calibration squat
                    console.log('Calibration progress update received');
                    
                    // The repCountChar should now have the current calibration rep count
                    if (repCountChar) {
                        try {
                            const repValue = await repCountChar.readValue();
                            const currentCalibrationRep = repValue.getUint8(0);
                            
                            // Update button text with progress
                            calibrateBtn.innerHTML = `<i data-lucide="target" class="w-4 h-4 mr-2"></i>Calibrating... (${currentCalibrationRep}/5)`;
                            sessionControlsStatus.textContent = `Calibration progress: ${currentCalibrationRep}/5 squats completed`;
                            lucide.createIcons();
                            
                            console.log(`Calibration progress: ${currentCalibrationRep}/5 squats completed`);
                        } catch (error) {
                            console.error('Error reading calibration rep count:', error);
                        }
                    }
                } else if (calibrationStatus === 2) {
                    // Calibration complete - read new target values
                    console.log('Calibration complete signal received');
                    
                    if (targetROMChar && targetSpeedChar) {
                        const romValue = await targetROMChar.readValue();
                        const speedValue = await targetSpeedChar.readValue();
                        
                        const newROM = romValue.getFloat32(0, true);
                        const newSpeed = speedValue.getFloat32(0, true);
                        
                        // Update settings with calibrated values
                        settings.targetROM = Math.round(newROM);
                        settings.speedTarget = parseFloat(newSpeed.toFixed(1));
                        
                        // Update display
                        updateSettingDisplay('rom', settings.targetROM);
                        updateSettingDisplay('speed', settings.speedTarget);
                        
                        // Save to localStorage
                        saveSettings();
                        
                        console.log(`Calibration updated: ROM=${settings.targetROM}Â°, Speed=${settings.speedTarget}Â°/s`);
                    }
                    
                    // Reset calibration state
                    isCalibrating = false;
                    calibrateBtn.innerHTML = '<i data-lucide="target" class="w-4 h-4 mr-2"></i>Calibrate';
                    calibrateBtn.classList.remove('bg-danger-gradient');
                    calibrateBtn.classList.add('bg-primary-gradient');
                    calibrateBtn.disabled = false;
                    sessionControlsStatus.textContent = 'Calibration complete! Ready for sessions';
                    lucide.createIcons();
                    
                    showError(`Calibration complete! New targets: ${settings.targetROM}Â° ROM, ${settings.speedTarget}Â°/s speed`);
                    setTimeout(hideError, 5000);
                }
            } catch (error) {
                console.error('Error handling calibration data:', error);
                showError(`Calibration error: ${error.message}`);
            }
        }

        function addRepCard(repNum, rom, speed, jerkiness) {
            // Handle calibration mode
            if (isCalibrating) {
                handleCalibrationRep(rom, speed, jerkiness);
                return; // Don't show individual rep cards during calibration
            }
            
            // Hide "no reps" message
            if (noRepsMessage) {
                noRepsMessage.style.display = 'none';
            }
            
            // Determine jerkiness text and status from RMS jerk value
            let jerkinessText, jerkinessStatus;
            if (jerkiness < 50) {
                jerkinessText = 'Smooth';
                jerkinessStatus = 'good';
            } else if (jerkiness < 150) {
                jerkinessText = 'Moderate';
                jerkinessStatus = 'caution';
            } else {
                jerkinessText = 'Jerky';
                jerkinessStatus = 'bad';
            }
            
            // Determine speed text and status using angular velocity (deg/s)
            // Lower speed = more controlled = better for rehabilitation
            const speedTarget = settings.speedTarget; // Now in deg/s
            let speedText, speedStatus;
            if (speed <= speedTarget) {
                speedText = 'Controlled';
                speedStatus = 'good';
            } else if (speed <= speedTarget * 1.5) {
                speedText = 'Moderate';
                speedStatus = 'caution';
            } else {
                speedText = 'Too Fast';
                speedStatus = 'bad';
            }
            
            // Determine ROM status using dynamic thresholds
            const romTarget = settings.targetROM;
            const romTolerance = 10; // Â±10 degrees
            const romStatus = (rom >= (romTarget - romTolerance) && rom <= (romTarget + romTolerance)) ? 'good' : 
                             (rom >= (romTarget - 25) && rom <= (romTarget + 25)) ? 'caution' : 'bad';
            
            // Determine overall badge
            const overallBadge = (romStatus === 'good' && speedStatus === 'good' && jerkinessStatus === 'good') ? 'good' :
                                 (romStatus === 'bad' || speedStatus === 'bad' || jerkinessStatus === 'bad') ? 'bad' : 'caution';

            console.log(`Rep ${repNum}: ROM=${rom}Â° (${romStatus}), Speed=${speed}s (${speedStatus}), Jerkiness=${jerkiness} (${jerkinessStatus}) â†’ Overall: ${overallBadge}`);

            const badgeColors = {
                good: 'bg-green-100 text-green-800',
                caution: 'bg-yellow-100 text-yellow-800', 
                bad: 'bg-red-100 text-red-800'
            };

            const valueColors = {
                good: 'text-green-600 bg-green-50',
                caution: 'text-yellow-600 bg-yellow-50',
                bad: 'text-red-600 bg-red-50'
            };

            const repCard = document.createElement('div');
            repCard.className = 'bg-white rounded-lg border border-gray-200 p-4 mb-3 shadow-sm hover:shadow-md transition-shadow';
            repCard.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-primary-gradient text-white rounded-full flex items-center justify-center text-sm font-bold">
                            ${repNum}
                        </div>
                        <span class="font-medium text-gray-900">Rep ${repNum}</span>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs font-medium ${badgeColors[overallBadge]}">
                        ${overallBadge === 'good' ? 'Good' : overallBadge === 'caution' ? 'Caution' : 'Poor'}
                    </span>
                </div>
                <div class="grid grid-cols-3 gap-3 text-sm">
                    <div class="text-center">
                        <div class="text-gray-500 text-xs">ROM Angle</div>
                        <div class="font-semibold ${valueColors[romStatus]} px-2 py-1 rounded">${rom}Â°</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-500 text-xs">Speed</div>
                        <div class="font-semibold ${valueColors[speedStatus]} px-2 py-1 rounded">${speedText}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-500 text-xs">Smoothness</div>
                        <div class="font-semibold ${valueColors[jerkinessStatus]} px-2 py-1 rounded">${jerkinessText}</div>
                    </div>
                </div>
            `;

            // Add to top of container with animation
            repContainer.insertBefore(repCard, repContainer.firstChild);

            // Store rep data
            repsData.push({ rom, speed, jerkiness, status: overallBadge });

            // Play sound alert for poor form
            if (settings.soundAlerts) {
                playSoundAlert(overallBadge);
            }
        }

        function updateSummary() {
            // Update total reps
            document.getElementById('totalReps').textContent = repsData.length;
            animateStatUpdate('totalRepsStat');
            
            // Update good reps count
            const goodReps = repsData.filter(r => r.status === 'good').length;
            document.getElementById('goodReps').textContent = goodReps;
            animateStatUpdate('goodRepsStat');
            
            // Update average ROM angle
            if (repsData.length > 0) {
                const avgRom = Math.round(repsData.reduce((sum, r) => sum + r.rom, 0) / repsData.length);
                document.getElementById('avgAngle').textContent = avgRom + 'Â°';
                animateStatUpdate('avgAngleStat');
            }
        }

        function animateStatUpdate(statId) {
            const stat = document.getElementById(statId);
            stat.classList.add('ring-2', 'ring-blue-300');
            setTimeout(() => {
                stat.classList.remove('ring-2', 'ring-blue-300');
            }, 300);
        }

        function updateDuration() {
            if (!sessionStartTime) return;
            const elapsed = Math.floor((Date.now() - sessionStartTime) / 60000);
            document.getElementById('duration').textContent = elapsed + ' min' + (elapsed !== 1 ? 's' : '');
            setTimeout(updateDuration, 10000); // Update every 10 seconds
        }

        function onDisconnected() {
            console.log('Device disconnected');
            resetConnectionState();
            showError('Device disconnected. Please reconnect to continue.');
        }

        function resetConnectionState() {
            statusDot.classList.remove('bg-green-400');
            statusDot.classList.add('bg-red-400');
            statusText.textContent = 'Not Connected';
            connectBtn.disabled = false;
            connectBtn.innerHTML = '<i data-lucide="bluetooth" class="w-4 h-4 mr-2"></i>Connect to REHABAND';
            connectBtn.classList.remove('bg-green-500');
            connectBtn.classList.add('bg-primary-gradient');
            
            // Disable session controls
            startResetBtn.disabled = true;
            startResetBtn.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed');
            calibrateBtn.disabled = true;
            calibrateBtn.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed');
            sessionControlsStatus.textContent = 'Connect to device to enable session controls';
            
            // Reset session state
            isSessionActive = false;
            startResetBtn.innerHTML = '<i data-lucide="play" class="w-4 h-4 mr-2"></i>Start Session';
            startResetBtn.classList.remove('bg-danger-gradient');
            startResetBtn.classList.add('bg-warning-gradient');
            
            // Reset calibration state
            if (isCalibrating) {
                isCalibrating = false;
                calibrateBtn.innerHTML = '<i data-lucide="target" class="w-4 h-4 mr-2"></i>Calibrate';
                calibrateBtn.classList.remove('bg-danger-gradient');
                calibrateBtn.classList.add('bg-primary-gradient');
            }
            
            // Reset session data
            sessionStartTime = null;
            lastRepCount = 0;
            
            lucide.createIcons();
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.querySelector('span').textContent = message;
            errorEl.classList.remove('hidden');
            
            // Auto hide after 10 seconds
            setTimeout(hideError, 10000);
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Session Control Functions
        async function toggleSession() {
            if (!isSessionActive) {
                // Start session
                isSessionActive = true;
                startResetBtn.innerHTML = '<i data-lucide="square" class="w-4 h-4 mr-2"></i>Reset Session';
                startResetBtn.classList.remove('bg-warning-gradient');
                startResetBtn.classList.add('bg-danger-gradient');
                
                // Send start command to Arduino with retry logic
                if (sessionControlChar) {
                    try {
                        await writeCharacteristicWithRetry(sessionControlChar, new Uint8Array([1]));
                        console.log('Start session command sent to Arduino');
                    } catch (error) {
                        console.error('Failed to send start command after retries:', error);
                        showError(`Failed to start session: ${error.message}`);
                    }
                }
                
                // Reset local session data
                repsData = [];
                lastRepCount = 0;
                sessionStartTime = Date.now();
                updateDuration();
                updateSummary();
                
                // Clear rep history display
                repContainer.innerHTML = '<div class="text-center text-gray-500 py-8"><i data-lucide="activity" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i><p class="text-sm">Session started! Begin exercising to see data.</p></div>';
                
                sessionControlsStatus.textContent = 'Session active - exercising...';
                showError('Session started! Current angle set as reference position.');
                
            } else {
                // Reset session
                isSessionActive = false;
                startResetBtn.innerHTML = '<i data-lucide="play" class="w-4 h-4 mr-2"></i>Start Session';
                startResetBtn.classList.remove('bg-danger-gradient');
                startResetBtn.classList.add('bg-warning-gradient');
                
                // Send reset command to Arduino with retry logic
                if (sessionControlChar) {
                    try {
                        await writeCharacteristicWithRetry(sessionControlChar, new Uint8Array([0]));
                        console.log('Reset session command sent to Arduino');
                    } catch (error) {
                        console.error('Failed to send reset command after retries:', error);
                        showError(`Failed to reset session: ${error.message}`);
                    }
                }
                
                // Reset session data
                repsData = [];
                lastRepCount = 0;
                sessionStartTime = Date.now();
                updateSummary();
                
                // Reset stats display
                document.getElementById('totalReps').textContent = '0';
                document.getElementById('goodReps').textContent = '0';
                document.getElementById('avgAngle').textContent = '--';
                
                // Clear rep history display
                repContainer.innerHTML = '<div class="text-center text-gray-500 py-8" id="noRepsMessage"><i data-lucide="activity" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i><p class="text-sm">Session reset. Start exercising to see data!</p></div>';
                
                sessionControlsStatus.textContent = 'Ready to start session or calibrate';
                showError('Session reset successfully!');
            }
            
            lucide.createIcons();
        }

        // BLE Retry Helper Function
        async function writeCharacteristicWithRetry(characteristic, value, maxRetries = 3, delay = 100) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    await characteristic.writeValue(value);
                    console.log(`BLE write successful on attempt ${attempt}`);
                    return true;
                } catch (error) {
                    console.warn(`BLE write attempt ${attempt} failed:`, error.message);
                    
                    if (attempt === maxRetries) {
                        throw error; // Throw error after all retries failed
                    }
                    
                    // Wait before retry
                    await new Promise(resolve => setTimeout(resolve, delay * attempt));
                }
            }
            return false;
        }

        // Calibration Functions
        async function startCalibration() {
            if (!device || !device.gatt.connected) {
                showError('Please connect to REHABAND device first');
                return;
            }
            
            if (isCalibrating) {
                showError('Calibration already in progress');
                return;
            }
            
            isCalibrating = true;
            calibrationData = [];
            calibrationCount = 0;
            
            calibrateBtn.innerHTML = '<i data-lucide="target" class="w-4 h-4 mr-2"></i>Calibrating... (0/5)';
            calibrateBtn.classList.remove('bg-primary-gradient');
            calibrateBtn.classList.add('bg-danger-gradient');
            calibrateBtn.disabled = true;
            sessionControlsStatus.textContent = 'Calibrating... Perform 5 good form squats';
            
            // Send calibration start command to Arduino with retry logic
            if (calibrationChar) {
                try {
                    await writeCharacteristicWithRetry(calibrationChar, new Uint8Array([1]));
                    console.log('Calibration start command sent to Arduino');
                } catch (error) {
                    console.error('Failed to send calibration command after retries:', error);
                    showError(`Calibration error: ${error.message}`);
                    
                    // Reset calibration state on failure
                    isCalibrating = false;
                    calibrateBtn.innerHTML = '<i data-lucide="target" class="w-4 h-4 mr-2"></i>Calibrate';
                    calibrateBtn.classList.remove('bg-danger-gradient');
                    calibrateBtn.classList.add('bg-primary-gradient');
                    calibrateBtn.disabled = false;
                    sessionControlsStatus.textContent = 'Ready to start session or calibrate';
                    return;
                }
            }
            
            // Send current target values to Arduino
            await sendSettingsToArduino();
            
            // Clear previous data
            repsData = [];
            lastRepCount = 0;
            
            // Clear rep history
            repContainer.innerHTML = '<div class="text-center text-blue-600 py-8"><i data-lucide="target" class="w-12 h-12 mx-auto mb-3"></i><p class="text-sm">Calibration in progress... Perform 5 good form squats.</p></div>';
            
            showError('Calibration started! Perform 5 squats with your best form.');
            lucide.createIcons();
        }

        function handleCalibrationRep(rom, speed, jerkiness) {
            if (!isCalibrating) return;
            
            calibrationCount++;
            calibrationData.push({ rom, speed, jerkiness });
            
            calibrateBtn.innerHTML = `<i data-lucide="target" class="w-4 h-4 mr-2"></i>Calibrating... (${calibrationCount}/5)`;
            lucide.createIcons();
            
            if (calibrationCount >= 5) {
                completeCalibration();
            }
        }

        function completeCalibration() {
            if (calibrationData.length < 5) return;
            
            // Calculate averages
            const avgROM = Math.round(calibrationData.reduce((sum, rep) => sum + rep.rom, 0) / calibrationData.length);
            const avgSpeed = parseFloat((calibrationData.reduce((sum, rep) => sum + rep.speed, 0) / calibrationData.length).toFixed(1));
            
            // Update settings with calibrated values
            settings.targetROM = avgROM;
            settings.speedTarget = avgSpeed;
            
            // Update display
            updateSettingDisplay('rom', avgROM);
            updateSettingDisplay('speed', avgSpeed);
            
            // Save to localStorage
            saveSettings();
            
            // Reset calibration state
            isCalibrating = false;
            calibrateBtn.innerHTML = '<i data-lucide="target" class="w-4 h-4 mr-2"></i>Calibrate';
            calibrateBtn.classList.remove('bg-danger-gradient');
            calibrateBtn.classList.add('bg-primary-gradient');
            calibrateBtn.disabled = false;
            sessionControlsStatus.textContent = 'Calibration complete! Ready for sessions';
            
            // Reset rep data
            repsData = [];
            lastRepCount = 0;
            
            // Clear rep history
            repContainer.innerHTML = '<div class="text-center text-gray-500 py-8" id="noRepsMessage"><i data-lucide="activity" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i><p class="text-sm">Calibration complete! Start exercising to see data!</p></div>';
            
            showError(`Calibration complete! New targets: ${avgROM}Â° ROM, ${avgSpeed}s speed`);
            setTimeout(hideError, 5000);
            lucide.createIcons();
        }

        // Demo Mode Functions
        function startDemoMode() {
            hideError();
            
            // Simulate connection
            statusDot.classList.remove('bg-red-400');
            statusDot.classList.add('bg-green-400');
            statusText.textContent = 'Connected (Demo)';
            connectBtn.style.display = 'none';
            demoBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin mr-2"></i>Demo Running...';
            demoBtn.disabled = true;
            demoBtn.classList.remove('bg-success-gradient');
            demoBtn.classList.add('bg-danger-gradient');
            
            // Show demo disclaimer
            demoDisclaimer.classList.remove('hidden');
            
            sessionStartTime = Date.now();
            updateDuration();
            
            // Generate demo reps with delays
            simulateReps();
            lucide.createIcons();
        }

        function simulateReps() {
            const demoReps = [
                { rep: 1, rom: 90, speed: 25.0, jerkiness: 40.0 }, // Good squat (parallel squat, controlled speed, smooth)
                { rep: 2, rom: 70, speed: 42.0, jerkiness: 120.0 }, // Caution squat (shallow squat, moderate speed, some jerk)
                { rep: 3, rom: 95, speed: 28.0, jerkiness: 45.0 }, // Good squat (good depth, controlled speed, smooth)
                { rep: 4, rom: 45, speed: 55.0, jerkiness: 200.0 }, // Poor squat (quarter squat - too shallow, too fast, jerky)
                { rep: 5, rom: 80, speed: 40.0, jerkiness: 100.0 }, // Caution squat (decent depth, moderate speed, some jerk)
            ];

            let currentRep = 0;
            
            function addNextRep() {
                if (currentRep < demoReps.length) {
                    const rep = demoReps[currentRep];
                    addRepCard(rep.rep, rep.rom, rep.speed, rep.jerkiness);
                    updateSummary();
                    currentRep++;
                    
                    // Schedule next rep (2-4 seconds apart)
                    const delay = 2000 + Math.random() * 2000;
                    setTimeout(addNextRep, delay);
                } else {
                    // Demo complete
                    demoBtn.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4 mr-2"></i>Demo Complete';
                    demoBtn.classList.remove('bg-danger-gradient');
                    demoBtn.classList.add('bg-green-500');
                    
                    // Show completion message
                    setTimeout(() => {
                        showError('Demo complete! This is how the interface looks with real Arduino data.');
                        
                        // Reset demo after 10 seconds
                        setTimeout(() => {
                            resetDemo();
                        }, 10000);
                    }, 1000);
                }
                lucide.createIcons();
            }
            
            // Start first rep after 1 second
            setTimeout(addNextRep, 1000);
        }

        function resetDemo() {
            // Reset UI state
            statusDot.classList.remove('bg-green-400');
            statusDot.classList.add('bg-red-400');
            statusText.textContent = 'Not Connected';
            connectBtn.style.display = '';
            demoBtn.innerHTML = '<i data-lucide="play-circle" class="w-4 h-4 mr-2"></i>Try Demo Mode';
            demoBtn.disabled = false;
            demoBtn.classList.remove('bg-green-500', 'bg-danger-gradient');
            demoBtn.classList.add('bg-success-gradient');
            
            // Hide demo disclaimer
            demoDisclaimer.classList.add('hidden');
            
            // Clear rep data
            repsData = [];
            sessionStartTime = null;
            
            // Reset stats
            document.getElementById('totalReps').textContent = '0';
            document.getElementById('goodReps').textContent = '0';
            document.getElementById('avgAngle').textContent = '--';
            document.getElementById('duration').textContent = '0 mins';
            
            // Clear rep cards
            repContainer.innerHTML = '<div class="text-center text-gray-500 py-8" id="noRepsMessage"><i data-lucide="activity" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i><p class="text-sm">No reps yet. Start exercising to see data!</p></div>';
            
            hideError();
            lucide.createIcons();
        }

        // Settings Management Functions
        async function sendSettingsToArduino() {
            if (targetROMChar && targetSpeedChar && isConnected()) {
                try {
                    await writeCharacteristicWithRetry(targetROMChar, new Float32Array([settings.targetROM]));
                    await writeCharacteristicWithRetry(targetSpeedChar, new Float32Array([settings.speedTarget]));
                    console.log(`Settings sent to Arduino: ROM=${settings.targetROM}Â°, Speed=${settings.speedTarget}Â°/s`);
                } catch (error) {
                    console.error('Failed to send settings to Arduino:', error);
                }
            }
        }

        function adjustSetting(type, change) {
            if (type === 'rom') {
                settings.targetROM = Math.max(30, Math.min(150, settings.targetROM + change));
                updateSettingDisplay('rom', settings.targetROM);
            } else if (type === 'speed') {
                settings.speedTarget = Math.max(20.0, Math.min(50.0, parseFloat((settings.speedTarget + change).toFixed(1))));
                updateSettingDisplay('speed', settings.speedTarget);
            }
            
            // Save to localStorage
            saveSettings();
            
            // Send updated settings to Arduino immediately if connected
            sendSettingsToArduino();
            
            // Visual feedback
            animateSettingChange(type);
        }

        function updateSettingDisplay(type, value) {
            if (type === 'rom') {
                romValue.innerHTML = `${value}<span class="text-xs text-gray-500 ml-1">Â°</span>`;
            } else if (type === 'speed') {
                speedValue.innerHTML = `${Math.round(value)}<span class="text-xs text-gray-500 ml-1">Â°/s</span>`;
            }
        }

        function animateSettingChange(type) {
            const element = type === 'rom' ? romValue : speedValue;
            element.classList.add('ring-2', 'ring-blue-300');
            setTimeout(() => {
                element.classList.remove('ring-2', 'ring-blue-300');
            }, 300);
        }

        function saveSettings() {
            localStorage.setItem('rehabandSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('rehabandSettings');
            if (saved) {
                const savedSettings = JSON.parse(saved);
                settings.targetROM = savedSettings.targetROM || 95;
                settings.speedTarget = savedSettings.speedTarget || 30.0;
                settings.soundAlerts = savedSettings.soundAlerts !== undefined ? savedSettings.soundAlerts : true;
                
                // Update display
                updateSettingDisplay('rom', settings.targetROM);
                updateSettingDisplay('speed', settings.speedTarget);
                updateSoundToggleDisplay();
            }
        }

        // Sound Alert Functions
        function playSoundAlert(overallBadge) {
            // Only beep for poor form - no sound for good form
            if (overallBadge === 'caution') {
                playTone(600, 0.15, 0.3); // Warning tone: medium pitch, short
            } else if (overallBadge === 'bad') {
                playTone(300, 0.4, 0.4); // Alert tone: lower pitch, longer
            }
            // No sound for 'good' - silent success
        }

        function playTone(frequency, duration, volume = 0.3) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (error) {
                console.log('Audio not supported or blocked:', error);
            }
        }

        function toggleSoundAlerts() {
            settings.soundAlerts = !settings.soundAlerts;
            updateSoundToggleDisplay();
            saveSettings();
            
            // Play test sound when enabling
            if (settings.soundAlerts) {
                playTone(600, 0.15, 0.3);
            }
        }

        function updateSoundToggleDisplay() {
            soundToggleBtn.textContent = settings.soundAlerts ? 'ON' : 'OFF';
            soundToggleBtn.classList.remove('bg-green-500', 'bg-red-500');
            soundToggleBtn.classList.add(settings.soundAlerts ? 'bg-green-500' : 'bg-red-500');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            console.log('REHABAND Modern UI loaded with Tailwind CSS');
            loadSettings(); // Load saved settings on page load
            lucide.createIcons(); // Initialize all icons
        });
    </script>
</body>
</html>